<% mark = count = rank = highest = 0; h = {} -%>
ID,順位,純得点,補正後得点,重複数,タイトル,漫画家,雑誌,入れた人
<% @series.each do |serie| -%>
<%= serie.id -%>
,<%= "#{mark == $2 && count == $3 && serie.ranks.where(:ranking_id => 1).order("rank DESC").first.rank == highest ? rank : rank += 1},#{$1},#{mark = $2},#{count = $3}" if /純得点\:\s(\d+)　補正後得点\:\s(\-?\d+)　重複数\:\s(\d+)$/ =~serie.url -%>
<% highest = serie.ranks.where(:ranking_id => 1).order("rank DESC").first.rank; h[serie.id] = rank -%>
,<%= serie.name -%>
,<%= serie.authors.map{|a| a.name}.join("・") if serie.authors -%>
,<%= serie.magazines.select("DISTINCT name").map{|m| m.name}.join("・") if serie.magazines -%>
,<%= serie.ranks.sort{|a, b| (a.ranking_id <=> b.ranking_id).nonzero? || a.rank <=> b.rank}.map{|r| "#{r.user.name}(#{r.ranking_id == 2 ? "糞" : nil}#{r.rank}位)"}.join(" ") -%>

<% end -%>
